---
title: "AEM: PS3"
author: "Maxwell Austensen"
date: "November 16, 2016"
output: html_notebook
---

```{r, message=FALSE, warning=FALSE}

# Install packages if needed
package_list <- c("tidyverse", "stargazer", "knitr", "haven", "stringr", "sandwich", "rdd")
new_packages <- package_list[! package_list %in% installed.packages()[,"Package"]]
if(length(new_packages)) install.packages(new_packages)

library(tidyverse)
library(rdd)

# Modification to stargazer() - escapes "*" to prevent html vs markdown confusion
stargazer_html <- function(...) {
  capture.output(stargazer::stargazer(..., type = "html", header = FALSE)) %>%
  stringr::str_replace_all("\\*", "\\\\*") %>% 
  paste(collapse = "\n") %>%
  cat("\n")
}
```


## Part 1

![](./ps3_q1.png)


***


```{r}
clark <- haven::read_stata("http://users.nber.org/~rdehejia/!@$AEM/Problem%20Sets/ps3/PS%203%20-%20Clark.dta")
glimpse(clark)
```

***

```{r}
# Helper function to add scatter plot points and format graphs
points_and_format <- function() {
  list(
    geom_point(aes(color = factor(win)), alpha = 0.5),
    guides(color = FALSE, alpha = FALSE),
    labs(
      y = "Change in pass rate of pupils \n(year immediately prior and two years after vote)",
      x = "Percentage vote in favour of the GM status"
    ),
    theme_minimal()
  )
}
```

## Part 2

```{r}
clark %>% 
  ggplot(aes(vote, dpass)) +
  geom_smooth(
    method = "lm", 
    formula = y ~ (x > 50) + poly(x, 2, raw = TRUE), 
    color = "black",
    level = .95
  ) +
  points_and_format()
```

```{r}
clark %>% 
  ggplot(aes(vote, dpass)) +
  geom_smooth(
    method = "lm", 
    formula = y ~ (x > 50) + poly(x, 3, raw = TRUE), 
    color = "black",
    level = .95
  ) +
  points_and_format()
```


```{r}
clark %>% 
  ggplot(aes(vote, dpass)) +
  geom_smooth(
    data = filter(clark, between(vote, 40, 60)),
    aes(vote, dpass), 
    method = "lm", formula = y ~ (x > 50) + poly(x, 3, raw = TRUE), 
    color = "black",
    level = .95
  ) +
  points_and_format()
```


```{r}
clark %>% 
  ggplot(aes(vote, dpass, group = factor(win))) +
  geom_smooth(
    method = "loess", 
    color = "black", 
    level = .95
  ) +
  points_and_format()
```


```{r}
clark %>% 
  ggplot(aes(vote, dpass, group = factor(win))) +
  geom_smooth(
    data = filter(clark, between(vote, 40, 60)),
    aes(vote, dpass), 
    method = "loess", 
    color = "black", 
    level = .95
  ) +
  points_and_format()
```

***


```{r}
# Helper function to fit model and get robust standard errors
model_prep <- function(.data, dep_var, rng){
  # construct formula
  f <- paste0(substitute(dep_var), " ~ win")
  
  # fit model on subset fo data defined by range of vote share
  m <-
    .data %>% 
    filter(between(vote, rng[1], rng[2])) %>% 
    lm(formula = f, data = .)
  
  # Robust stanadard errors (replicating Stat's robust option)
  robust_se <- 
    m %>% 
    vcovHC(type = "HC1") %>% 
    diag() %>% 
    sqrt()
  
  return(list(m, robust_se))
}
```

## Part 3

```{r, results = 'asis'}
m1 <- clark %>% model_prep(dpass, c(15, 85))
m2 <- clark %>% model_prep(dpass, c(25, 75))
m3 <- clark %>% model_prep(dpass, c(33.33, 66.66))

stargazer_html(
  m1[1], m2[1], m3[1], 
  se = list(m1[[2]], m2[[2]], m3[[2]]),
  keep.stat = c("n", "rsq")
)
```

***

## Part 4

```{r, results = 'asis'}
m1 <- clark %>% model_prep(passrate2, c(15, 85))
m2 <- clark %>% model_prep(passrate2, c(25, 75))
m3 <- clark %>% model_prep(passrate2, c(33.33, 66.66))

stargazer_html(
  m1[1], m2[1], m3[1], 
  se = list(m1[[2]], m2[[2]], m3[[2]]),
  keep.stat = c("n", "rsq")
)
```

```{r}
rd_obj <- clark %>% RDestimate(data = ., formula = dpass ~ vote, cutpoint = 50)
rd_obj
```

***

## Part 5


```{r}

clark %>% 
  ggplot(aes(vote, passrate0, group = factor(win))) +
  geom_smooth(
    method = "loess", 
    color = "black", 
    level = .95
  ) +
  points_and_format()
```



```{r, results = 'asis'}
m1 <- clark %>% model_prep(passrate0, c(0, 100))

stargazer_html(
  m1[[1]],
  se = list(m1[[2]]),
  keep.stat = c("n", "rsq")
)
```

***

## Part 6

```{r}
DCdensity(clark$vote, cutpoint = 50, verbose = TRUE, plot = TRUE)
```

***

## Part 7

```{r}
bandwidths <- seq(0.75, 1.25, 0.10) %>% map_dbl(~ .x * rd_obj$bw[[1]])

rd_robust <- 
  clark %>% 
  RDestimate(data = ., formula = dpass ~ vote, cutpoint = 50, bw = bandwidths)

tibble(
  Bandwidth = rd_robust$bw, 
  `% of Optimal Bandwidth` = seq(75, 125, 10),
  Observations = rd_robust$obs,
  `LATE Estimate` = rd_robust$est,
  `Standard Error` = rd_robust$se,
  `P Value` = rd_robust$p,
  `95% Confidence Interval` = map2_chr(rd_robust$ci[, 1], rd_robust$ci[, 2], 
                                ~ stringr::str_c(round(.x, 3), round(.y, 3), sep = ", "))
) %>% 
knitr::kable(digits = 3)
```






