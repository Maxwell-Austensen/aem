---
title: "AEM Replication: 1"
author: "Maxwell Austensen"
date: "`r Sys.Date()`"
output: html_notebook
---


```{r, message=FALSE, warning=FALSE, include=FALSE}
# Install packages if needed
package_list <- c("haven", "stringr", "tidyverse", "janitor", "feather", "knitr", "rmarkdown")
new_packages <- package_list[!package_list %in% installed.packages()[,"Package"]]
if(length(new_packages)) install.packages(new_packages)

library(haven)
library(stringr)
library(tidyverse)
library(janitor)
library(feather)

# Set directories
data_dir <- "C:/Users/austensen/Downloads/"
```

```{r}
raw <- read_stata(str_c(data_dir, "usa_00005.dta"))
```

```{r}
raw %>% select(noquote(order(colnames(raw)))) %>% glimpse()
```

```{r, women_exclusions}
mothers <-
  raw %>%
  mutate(
    # keep all relates
    us_born = if_else(bpl < 56, 1, 0),
    white = if_else(race == 1, 1, 0),
    women = if_else(sex ==2, 1, 0),
    age_21_40 = if_else(between(age, 21, 40), 1, 0),
    ever_married = if_else(between(marrno, 1, 6), 1, 0),
    married_17_26 = if_else(between(agemarr, 17, 26), 1, 0),
    ever_child = if_else(chborn > 1, 1, 0),
    non_widow = if_else(marst != 5, 1, 0),
    not_allocated = 0,
      not_allocated = if_else(qage == 0, 1, not_allocated),
      not_allocated = if_else(qmarrno %in% c(0, 3), 1, not_allocated),
      not_allocated = if_else(qmarst %in% c(0, 3), 1, not_allocated),
      not_allocated = if_else(qagemarr %in% c(0, 3), 1, not_allocated),
      not_allocated = if_else(qchborn == 0, 1, not_allocated),
      not_allocated = if_else(qrelate %in% c(0, 3), 1, not_allocated), # why not qrelate2 ?
      not_allocated = if_else(qsex %in% c(0, 3), 1, not_allocated)
  ) %>% 
  filter(
    head_spouse,
    us_born,
    white,
    women,
    age_21_40,
    ever_married,
    married_17_26,
    ever_child,
    non_widow,
    not_allocated
  )
# no dupes
```

```{r}
fathers <-
  raw %>% 
  filter(sex == 1) %>% # keep all relates, use sloc to: keep only if wife in household and merege fathers with mothers
  semi_join(mothers, by = "serial") %>% # in households /w sample mothers
  anti_join(mothers, by = c("serial", "pernum")) # not sample mothers
# no dupes

children <-
  raw %>% 
  # Keep all relates, use mloc to: keep kids with mothers, get sibling groups, and to merge with mothers
  semi_join(mothers, by = "serial") %>% 
  group_by(serial) %>% 
  mutate(
    oldest = if_else(age == max(age), 1, 0), # Should test with birth month also
    not_twin = if_else(sum(oldest) == 1, 1, 0),
    children_home = n()
  ) %>% 
  arrange(desc(age)) %>% 
  distinct(.keep_all = TRUE) %>% 
  ungroup() %>% 
  mutate(
    not_allocated = 0,
      not_allocated = if_else(qage == 0, 1, not_allocated),
      not_allocated = if_else(qsex %in% c(0, 3), 1, not_allocated),
      not_allocated = if_else(qrelate %in% c(0, 3), 1, not_allocated), # why not qrelate2 ?
      not_allocated = if_else(qbirthmo == 0, 1, not_allocated)
  )
# no dupes
```

```{r}
families <-
  mothers %>% 
  left_join(fathers, by = "serial") %>% 
  left_join(children, by = "serial") %>% 
  filter(
    not_twin,
    not_allocated.y
  )
# no dupes
```


```{r}
write_feather(families, str_c(data_dir, "families.feather"))
```



